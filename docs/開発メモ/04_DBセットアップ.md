# DB セットアップ

## NuGet 追加

- [Npgsql.EntityFrameworkCore.PostgreSQL](https://www.nuget.org/packages/Npgsql.EntityFrameworkCore.PostgreSQL)
  - PostgreSQL 用のデータベースプロバイダ
- [Microsoft.EntityFrameworkCore.Design](https://www.nuget.org/packages/microsoft.entityframeworkcore.design/)
  - dotnet ef migrations の実行に必要

## Entity クラス 作成

- [Entities/Note.cs](../../ChoiceNote.WebAPI/Entities/Note.cs)

## DbContext 作成

```cs:ChoiceNoteDbContext.cs
public class ChoiceNoteDbContext: DbContext
{
    public ChoiceNoteDbContext(
        DbContextOptions<ChoiceNoteDbContext> options): base(options){}

    public DbSet<Note> Notes { get; set;}
}
```

## 接続文字列追加

- appsettings.Development.json (開発用)

```json:appsettings.Development.json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=ChoiceNote;User Id=user;Password=password;"
  }
}
```

- appsettings.json (本番用)

Render.com の環境変数に「DefaultConnection」として設定する

- docker-compose.yml

```yml
services:
  choice-note:
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: Host=db;Port=5432;Database=ChoiceNote;Username=user;Password=password
```

## Program.cs へ DbContext の追加

```cs
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddDbContext<ChoiceNoteDbContext>(options =>
    options.UseNpgsql(
        builder.Configuration.GetConnectionString("DefaultConnection")
        ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found."))
);
```

## マイグレーション

```zsh
% dotnet ef migrations add AddNote
% dotnet ef database update
```

## 時刻自動更新する場合

```cs:ChoiceNoteDbContext.cs
    public override int SaveChanges()
    {
        ApplyTimestamps();
        return base.SaveChanges();
    }

    public override async Task<int> SaveChangesAsync(
        CancellationToken cancellationToken = default)
    {
        ApplyTimestamps();
        return await base.SaveChangesAsync(cancellationToken);
    }

    /// <summary>
    /// エンティティのCreatedAtとUpdatedAtを自動設定
    /// </summary>
    private void ApplyTimestamps()
    {
        var entries = ChangeTracker
            .Entries()
            .Where(e => e.Entity is Note &&
                (e.State == EntityState.Added ||
                    e.State == EntityState.Modified));

        foreach (var entry in entries)
        {
            var entity = (Note)entry.Entity;
            var now = DateTime.UtcNow;

            if (entry.State == EntityState.Added)
            {
                entity.CreatedAt = now;
            }

            entity.UpdatedAt = now;
        }
    }
```
